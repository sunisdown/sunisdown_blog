<!doctype html>
<html lang="zh" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>Python 元类</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="sunisdown">

  <link rel="shortcut icon" href="">

  <!-- schema.org -->
  <meta itemprop="name" content="SunisDown">
  <meta itemprop="image" content="">
  <meta itemprop="description" content="">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
  <!-- Style Meta Data -->
  <link rel="stylesheet" href="http://sunisdown.me/theme/css/style.css" type="text/css" />
  <link rel="stylesheet" href="http://sunisdown.me/theme/css/pygments.css" type="text/css" />

  <!-- Feed Meta Data -->
    <link href="http://sunisdown.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="SunisDown ATOM Feed" />

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="http://sunisdown.me/python-yuan-lei.html">
<meta name="twitter:title" content="SunisDown ~ Python 元类">
<meta name="twitter:description" content="<p><tt class="docutils literal">Python</tt>中有三个概念比较难懂，分别是：</p>
<ul class="simple">
<li>装饰器</li>
<li>描述符</li>
<li>元类</li>
</ul>
<p>这三种概念里面，元类又最为难懂，威力最强。</p>
<div class="section" id="id1">
<h2>类型，类，对象</h2>
<p>神说<tt class="docutils literal">万物皆对象</tt>，Python
中一切都是对象，凡是对象必先有类型。类，也是对象的一种。Python
中所有的对象都有一些相同的内容，包含在对象的<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L106">头部信息</a>中。</p>
<pre class="code c literal-block">
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_object</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
<span class="p">}</span> <span class="n">PyObject</span><span class="p">;</span>
</pre>
<p>在
<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L78">PyObject</a>
的定义中，<tt class="docutils literal">ob_refcnt</tt>
是<tt class="docutils literal">应用计数</tt>，用来做内存管理垃圾回收有关，这里暂时不细说。有兴趣的可以查看<a class="reference external" href="https://github.com/qyuhen/book">Q.yuhen的
Python 笔记</a>,</p>
<pre class="code c literal-block">
<span class="cm">/* PyObject_HEAD defines the initial segment of every PyObject ...</span></pre></div>">

<!-- Facebook Meta Data -->
<meta property="og:title" content="SunisDown ~ Python 元类" />
<meta property="og:description" content="<p><tt class="docutils literal">Python</tt>中有三个概念比较难懂，分别是：</p>
<ul class="simple">
<li>装饰器</li>
<li>描述符</li>
<li>元类</li>
</ul>
<p>这三种概念里面，元类又最为难懂，威力最强。</p>
<div class="section" id="id1">
<h2>类型，类，对象</h2>
<p>神说<tt class="docutils literal">万物皆对象</tt>，Python
中一切都是对象，凡是对象必先有类型。类，也是对象的一种。Python
中所有的对象都有一些相同的内容，包含在对象的<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L106">头部信息</a>中。</p>
<pre class="code c literal-block">
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_object</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
<span class="p">}</span> <span class="n">PyObject</span><span class="p">;</span>
</pre>
<p>在
<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L78">PyObject</a>
的定义中，<tt class="docutils literal">ob_refcnt</tt>
是<tt class="docutils literal">应用计数</tt>，用来做内存管理垃圾回收有关，这里暂时不细说。有兴趣的可以查看<a class="reference external" href="https://github.com/qyuhen/book">Q.yuhen的
Python 笔记</a>,</p>
<pre class="code c literal-block">
<span class="cm">/* PyObject_HEAD defines the initial segment of every PyObject ...</span></pre></div>" />
<meta property="og:image" content="" />
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <!--<center><a href="http://sunisdown.me"><img id="avatar" src=""></a></center>-->
    <h1>SunisDown</h1>
    <br>


    <nav class="nav">
      <ul class="list-bare">
      
          <li><a class="nav__link" href="/index.html">Blog</a></li>
          <li><a class="nav__link" href="/archives.html">Archives</a></li>
          <li><a class="nav__link" href="/tags.html">Tags</a></li>
         
          <li><a class="nav__link" href="http://sunisdown.me/pages/about.html">About</a></li>
         
      </ul>
    </nav>

    <p class="social">
        <a href="https://github.com/sunisdown" target="_blank" ><img src="http://sunisdown.me/theme/images/icons/github.png"></a>
        <a href="https://twitter.com/SunisD0wn" target="_blank" ><img src="http://sunisdown.me/theme/images/icons/twitter.png"></a>
      <a href="http://sunisdown.me/feeds/all.atom.xml" rel="alternate">
        <img src="http://sunisdown.me/theme/images/icons/rss.png"></a>
    </p>

    <!--
    <h2>Categories</h2>
    <ul class="navbar">
      <li class="active"><a href="http://sunisdown.me/category/articles.html">articles</a></li>
    </ul> 
    -->
  </aside>

  <!-- Content -->
  <article>
<section id="content">
    <article>
        <h2 class="post_title post_detail"><a href="http://sunisdown.me/python-yuan-lei.html" rel="bookmark" title="Permalink to Python 元类">Python 元类</a></h2>
        <div class="entry-content blog-post">
            <p><tt class="docutils literal">Python</tt>中有三个概念比较难懂，分别是：</p>
<ul class="simple">
<li>装饰器</li>
<li>描述符</li>
<li>元类</li>
</ul>
<p>这三种概念里面，元类又最为难懂，威力最强。</p>
<div class="section" id="id1">
<h2>类型，类，对象</h2>
<p>神说<tt class="docutils literal">万物皆对象</tt>，Python
中一切都是对象，凡是对象必先有类型。类，也是对象的一种。Python
中所有的对象都有一些相同的内容，包含在对象的<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L106">头部信息</a>中。</p>
<pre class="code c literal-block">
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_object</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
<span class="p">}</span> <span class="n">PyObject</span><span class="p">;</span>
</pre>
<p>在
<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Include/object.h#L78">PyObject</a>
的定义中，<tt class="docutils literal">ob_refcnt</tt>
是<tt class="docutils literal">应用计数</tt>，用来做内存管理垃圾回收有关，这里暂时不细说。有兴趣的可以查看<a class="reference external" href="https://github.com/qyuhen/book">Q.yuhen的
Python 笔记</a>,</p>
<pre class="code c literal-block">
<span class="cm">/* PyObject_HEAD defines the initial segment of every PyObject. */</span>
<span class="cp">#define PyObject_HEAD                   \
    _PyObject_HEAD_EXTRA                \
    Py_ssize_t ob_refcnt;               \
    struct _typeobject *ob_type;</span>
</pre>
<p><tt class="docutils literal">ob_type</tt>则是指向指向具体类型的指针。里面定义各种 Python
的类型。每一个对象都有他的类型。</p>
<p>下面跟我念：Python
中万物皆对象，对象皆有类型，且类型也是一个对象。上面我们说了每一个对象都有一个<tt class="docutils literal">类型指针</tt>指向他的类型，我们可以通过类型指针来判断对象的类型。</p>
<p>那么问题来了：我们通过什么来确定一个对象其实是一个类型对象？答案就是
<tt class="docutils literal">metaclass</tt>，所有 class 的 class，所有类型的类型。</p>
<p>举个栗子：</p>
<pre class="code python literal-block">
<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">NewData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">pass</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">NewData</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">NewData</span><span class="o">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">type</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">type</span><span class="p">(</span><span class="n">NewData</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">type</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">newdata</span><span class="o">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">__main__</span><span class="o">.</span><span class="n">NewData</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nb">type</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">__main__</span><span class="o">.</span><span class="n">NewData</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="nb">type</span><span class="o">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="nb">type</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">type</span><span class="o">.</span><span class="n">__base__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">object</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">NewData</span><span class="o">.</span><span class="n">__base__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="nb">object</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="nb">type</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="nb">type</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="nb">object</span><span class="o">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="nb">type</span>
</pre>
<p>从上面的栗子中我们可以观察到，<tt class="docutils literal">NewData</tt>与<tt class="docutils literal">type</tt>以及<tt class="docutils literal">object</tt>的类型都是
<em>type</em>，这 里面的类型 <em>type</em> 就是
<tt class="docutils literal">metaclass</tt>的一种，现在理一下元类，类型，类，实例之间的关 系：</p>
<ul class="simple">
<li>实例的类型是类 newdata.<strong>class</strong> == class</li>
<li>类的类型是元类 NewData.<strong>class</strong> == metaclass #type</li>
</ul>
</div>
<div class="section" id="metaclass">
<h2><strong>metaclass</strong></h2>
<p>Python 中 <tt class="docutils literal">class</tt> 关键字会
<a class="reference external" href="https://github.com/python/cpython/blob/2.7/Python/ceval.c#L4621">创建类的对象</a>，
我们观察一下类的创建过程:</p>
<pre class="code c literal-block">
<span class="k">if</span> <span class="p">(</span><span class="n">PyDict_Check</span><span class="p">(</span><span class="n">methods</span><span class="p">))</span>
    <span class="n">metaclass</span> <span class="o">=</span> <span class="n">PyDict_GetItemString</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="s">&quot;__metaclass__&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">metaclass</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">metaclass</span><span class="p">);</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">PyTuple_Check</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">metaclass</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;__class__&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metaclass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_Clear</span><span class="p">();</span>
        <span class="n">metaclass</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">metaclass</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>先检测在类的定义中是否指定了<tt class="docutils literal">__metaclass__</tt>，如果没有自己定义，则使用<tt class="docutils literal">object</tt>的
<tt class="docutils literal">__class__</tt>来作为元类，上面演示过<tt class="docutils literal">object.__class__</tt>
是<tt class="docutils literal">type</tt>。</p>
</div>
<div class="section" id="id2">
<h2>如何使用元类</h2>
<p>上面一节讲到，如果自己没有定义<tt class="docutils literal">__metaclass__</tt>的时候，则会使用默认的元类<tt class="docutils literal">type</tt>。
而这一节则会实验如何自己创建一个自定义元类。假设我是一个非常自恋的码农，别人把我
的名字从 Auth
里面抹去这种事儿不能忍，这种情况下也可以蛋疼的用元类（这真的是一个
蛋疼的栗子）：</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">AuthMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="s2">&quot;SunisDown&quot;</span>
        <span class="k">return</span> <span class="n">t</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">AuthMeta</span>
    <span class="k">pass</span>

<span class="n">aaa</span> <span class="o">=</span> <span class="n">Blog</span><span class="p">()</span>

<span class="n">aaa</span><span class="o">.</span><span class="n">auth</span> <span class="o">==</span> <span class="s1">'SunisDown'</span>
</pre>
<p>如上所示，在后续的代码中，只要将__metaclass__ 指向
<tt class="docutils literal">AuthMeta</tt>，后面的类就有了属
性<tt class="docutils literal">auth</tt>，嗯，这个蛋疼的作者名字跟代码永远的绑到一起了。</p>
<p><tt class="docutils literal">import this</tt>的作者 Tim Peters
说过描述元类的话，能够非常到位的描述出元类在 Python 中的超然位置:</p>
<pre class="literal-block">
99%的用户不需要为元类这种黑魔法过渡操心.如果你想搞清楚究竟是否需要用到元类，那么你就不需要它。那些实际用到元类的人都非常 清楚地知道他们需要做什么，而且根本不需要解释为什么要用元类。
</pre>
<p>在 Django 的
<a class="reference external" href="https://github.com/django/django/blob/master/django/db/models/base.py#L60">models</a>
中，对于元类的使用可以算是一次教科书式的使用。</p>
<p>通过继承<tt class="docutils literal">models.Models</tt>里面的元类，我们就可以直接写类似：</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</pre>
<p>这种简单方便的
API，用户可以直接使用，而后面负责的逻辑，就隐藏在元类之中。</p>
</div>

        </div>
        <div class="post_list">
            <span>By </span>
            <a href="http://sunisdown.me/author/sunisdown.html">@Sunisdown</a>
            <span> in </span>
            <span class="post_category"><a href="http://sunisdown.me/category/articles.html" rel="bookmark" title="Permalink to articles">[ articles ]</a></span>
            <span class="post_date">Mon 29 December 2014</span>
            <div><span>Tags : </span>
                <span><a href="http://sunisdown.me/tag/python.html">#python, </a></span>
            </div>

            <div class="entry-social">
                <span class="twitter"><a target="_blank" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;" title="Twitter" href="https://twitter.com/share?url=http://sunisdown.me/python-yuan-lei.html&text=Python 元类&via="><img src="http://sunisdown.me/theme/images/icons/twitter-s.png"></a></span>

                <span class="gplus"><a target="_blank" title="Google +" href="https://plus.google.com/share?url=http://sunisdown.me/python-yuan-lei.html&hl=fr" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img src="http://sunisdown.me/theme/images/icons/google-s.png"></a></span>

                <span class="facebook"><a target="_blank" title="Facebook" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;" href="https://www.facebook.com/sharer.php?u=http://sunisdown.me/python-yuan-lei.html&t=Python 元类"><img src="http://sunisdown.me/theme/images/icons/facebook-s.png"></a></span>

                <a  target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://sunisdown.me/python-yuan-lei.html&title=Python 元类" rel="nofollow" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img src="http://sunisdown.me/theme/images/icons/linkedin-s.png"></a>

                <span class="mail"><a href="mailto:?subject=Python 元类&amp;body=Viens découvrir un article à propos de [Python 元类] sur le site de sunisdown. http://sunisdown.me/python-yuan-lei.html" title="Share by Email" target="_blank"><img src="http://sunisdown.me/theme/images/icons/mail-s.png"></a></span>
            </div>
        </div>
    </article>
</section>
  </article>

  <!-- Footer -->
  <footer>
    <p>
      Blog powered by <a href="http://getpelican.com/">Pelican</a>, 
      which takes great advantage of <a href="http://python.org">Python</a>.
      Theme <a href="https://github.com/parbhat/pelican-blue">Pelican-Blue</a> by <a href="https://parbhatpuri.com/">@parbhat</a>.
    </p>
  </footer>


</body>
</html>